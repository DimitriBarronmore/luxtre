@import "$basic_lua"

@operators {
	'->',
    '=>',
    '+=',
    '-=',
    '/=',
    '*=',
    '%=',
    '^=',
	'&=',
	'|=',
--    '++',
	'!=',
}


--[[ != Syntax ]]--
binop -> '!=' {% out:line():append("~=") %}

--[[ Table/String Colon-Syntax ]]--
function_call -> (table_constructor | String) ':' Name arguments {%
		local ln = out:line()
		ln:append("(")
		self.children[1]:print(out)
		ln:append(")")
		self.children[2]:print(out)
		self.children[3]:print(out)
		self.children[4]:print(out)
	%}


--[[ Augmented Assignment ]]--
statement -> augmented_assignment
augmented_assignment -> variable_list augmented_op expression_list {%
	local lhtab = { self.children[1].children[1] }
	local gathertab = self.children[1].children[2]:print(out,true)
	for i, child in ipairs(gathertab) do
		table.insert(lhtab, child.children[2])
	end
	
	local rhtab = { self.children[3].children[1] }
	local gathertab = self.children[3].children[2]:print(out,true)
	for i, child in ipairs(gathertab) do
		table.insert(rhtab, child.children[2])
	end
	
	local op = self.children[2]:print()
	local ln = out:line()
	
	self.children[1]:print(out)
	ln:append("=")
	
	for i, var in ipairs(lhtab) do
		rhvar = rhtab[i]
		var:print(out)
		ln:append(op .. " (")
		if rhvar then
			rhvar:print(out)
		else
			ln:append("nil")
		end
		ln:append(")")
		if i ~= #lhtab then
			ln:append(",")
		end
	end
%}

augmented_op -> '+=' {% return "+" %}
augmented_op -> '-=' {% return "-" %}
augmented_op -> '/=' {% return "/" %}
augmented_op -> '*=' {% return "*" %}
augmented_op -> '%=' {% return "%" %}
augmented_op -> '^=' {% return "^" %}
augmented_op -> '&=' {% return "and" %}
augmented_op -> '|=' {% return "or" %}


--[[ Table Constructors ]]--

@reset field
field -> field_lh field_assignment expression

field_lh -> Name
field_lh -> expression {%
	local ln = out:line()
	ln:append "["
	self.children[1]:print(out)
	ln:append "]"
%}

field_assignment -> '='
	| ':' 
	{% out:line():append("=") %}


--[[ Arrow Lambdas ]]--
anonymous_function -> lambda
statement -> lambda_function_assignment
statement -> lambda_local_function_assignment

lambda_function_assignment -> function_name lambda {% 
	local ln = out:line()
	self.children[1]:print(out)
	ln:append "="
	self.children[2]:print(out)
%}

lambda_local_function_assignment -> local function_name lambda {% 
	local ln = out:line()
	self.children[1]:print(out)
	self.children[2]:print(out)
	ln:append "="
	self.children[3]:print(out)
%}

lambda ->  ['(' paramlist ')' ] ('->' | '=>') statement {%
	local params = self.children[1].children
	local arrow_type = self.children[2].children[1].value
	local ln = out:line()

	ln:append "function("
	if arrow_type == "=>" then
		ln:append "self"
	end
	if #params > 0 then
		if arrow_type == "=>" then
			ln:append ","
		end
		self.children[1].children[2]:print(out)
	end
	ln:append ")"
	self.children[3]:print(out)
	ln:append "end"
%}
